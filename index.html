<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title></title>
<style type="text/css">
.hide{}
</style>
</head>
<body>
<script type="text/template" id="template_main">
<ul class="archive">
<% _.each(article, function(article, i){ %>
    <li><a href="#!article/<%= article.link %>"><%= article.title %></a></li>
    <% if( (i % 9 == 0) && (i != 0) ){ %>
        </ul>
        <ul class="archive hide">
    <% } %>
<% }); %>
</ul>
</script>

<script type="text/template" id="template_pagination">
<div class="pagination">
<% var n = 0; %>
<% _.each(article, function(article, i){ %>
    <% if( (i % 9 == 0) && (i != 0) ){ %>
        <a href="#!page/<%- n %>"><%- n %></a>
        <% n++; %>
    <% } %>
<% }); %>
</div>
</script>

<script type="text/template" id="template_article">
<div><a href="/" title="返回">&#171;</a></div>
<%= post =%>
</script>


<div id="main"></div>
<div id="pagination"></div>

<script src="json2.js"></script>
<script src="jquery.min.js"></script>
<script src="underscore-min.js"></script>
<script src="backbone-min.js"></script>
<script src="showdown-min.js"></script>
<script>
$(function(){
    var blog = {};

    var ViewMain = Backbone.View.extend({
        main: "#main",
        pagination: "#pagination",

        initialize: function(){
            var that = this;
            if(!blog.data){
                $.getJSON("meta.json", function(data){
                    blog.data = data;
                    that.make(blog.data);
                });
            }
        },

        make: function(context){
            var template_main = _.template($("#template_main").html(), context);
            $(this.main).html(template_main);

            /*var template_pagination = _.template($("#template_pagination").html(), context);
            $(this.pagination).html(template_pagination);*/
        }
    });

    var ViewArticle = Backbone.View.extend({
        el: "#main",
        initialize: function(){
            var md = new Showdown.converter();
            $.get('article/' + blog.article + ".md", function(data){

                var post = "<p><a href='/'>&#171;</a></p>" + md.makeHtml(data);
                $("#main").html(post);
            });
        }
    });

    var AppRouter = Backbone.Router.extend({
        routes: {
            ""  : "index",
            "!article/:title": "article"
        },

        index: function(){
            if(!view_main){
                var view_main = new ViewMain;
            }
            
            console.log("index")
        },

        article: function(title){
            blog.article = title;
            if(!view_article){
                var view_article = new ViewArticle;
            }
            console.log("article")
        }
    });

    
    var app = new AppRouter();
    Backbone.history.start();
})
</script>
</body>
</html>